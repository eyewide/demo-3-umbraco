@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using Umbraco.Cms.Core.Models.PublishedContent
@using System

@{
    var home = Model?.Root();
    var scriptsInEndOfBody = home?.Value<string>("scriptsInEndOfBody");
    var youTubeUrl = Model?.Value<string>("youTubeVideoUrl");
}

<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- fslightbox -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fslightbox/3.0.9/index.min.js"></script>

<!-- Flatpick -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- My Scripts -->
@if (!string.IsNullOrWhiteSpace(scriptsInEndOfBody))
{
    @Html.Raw(scriptsInEndOfBody)
}
<script src="@Url.Content("~/scripts/scripts.js")"></script>

@if (Model?.IsDocumentType("homePage") == true){
    <script>
    const firstSection = document.querySelectorAll("body section")[0];
    // Επιλέγω το h2 μέσα σε αυτό
    const h2 = firstSection.querySelector('h2');
    
    // Δημιουργώ ένα νέο h1 με το ίδιο περιεχόμενο
    const h1 = document.createElement('h1');
    h1.innerHTML = h2.innerHTML;
    
    // Αντικαθιστώ το h2 με το h1
    h2.replaceWith(h1);
    </script>
}


<!-- YouTube / Plyr -->
@if (!string.IsNullOrWhiteSpace(youTubeUrl) &&
     youTubeUrl.IndexOf("youtu", StringComparison.OrdinalIgnoreCase) >= 0)
{
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        const player = new Plyr('#player', {
            settings: ['speed'],
            muted: true,
            clickToPlay: false,
            autoplay: true,
            loop: { active: true }
        });
    </script>
}

<!-- Schema JSON -->
@if (!string.IsNullOrWhiteSpace(Model?.Value<string>("schemaJson")))
{
    @Html.Raw(Model.Value<string>("schemaJson"))
}

<!-- Gallery Masonry -->
@if (Model?.IsDocumentType("GalleryPage") == true)
{
    <script>
(function () {
    const gallery = document.getElementById('gallery');
    if (!gallery) return;

    function imagesLoaded(parent, cb) {
        const imgs = parent.querySelectorAll('img');
        let count = imgs.length;
        if (!count) return cb();
        imgs.forEach(img => {
            if (img.complete && img.naturalHeight !== 0) {
                if (--count === 0) cb();
            } else {
                img.addEventListener('load', () => { if (--count === 0) cb(); });
                img.addEventListener('error', () => { if (--count === 0) cb(); });
            }
        });
    }

    function getColumns() {
        const width = window.innerWidth;

        if (width < 767) return 2;
        if (width < 1199) return 3;
        return 4;
    }

    function layoutMasonry() {
        const containerWidth = gallery.clientWidth;
        const gap = 20;

        const cols = getColumns();
        const colW = Math.floor((containerWidth - (cols - 1) * gap) / cols);
        const heights = new Array(cols).fill(0);

        const items = Array.from(gallery.querySelectorAll('.masonry-item'));
        items.forEach(item => {
            item.style.width = colW + 'px';

            const shortestCol = heights.indexOf(Math.min(...heights));
            const x = shortestCol * (colW + gap);
            const y = heights[shortestCol];
            item.style.transform = `translate(${x}px, ${y}px)`;

            const itemH = item.getBoundingClientRect().height;
            heights[shortestCol] += itemH + gap;
        });

        gallery.style.height = Math.max(...heights) + 'px';
    }

    function debounce(fn, wait = 100) {
        let t;
        return (...args) => { 
            clearTimeout(t); 
            t = setTimeout(() => fn(...args), wait); 
        };
    }

    imagesLoaded(gallery, layoutMasonry);
    window.addEventListener('resize', debounce(layoutMasonry, 150));
})();
</script>

}
